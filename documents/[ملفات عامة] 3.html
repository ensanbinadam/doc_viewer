<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØªØ­Ù„ÙŠÙ„ÙŠ Ø§Ù„Ø´Ø§Ù…Ù„ - Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #27ae60;
            --accent-color: #2980b9;
            --info-bg: #e8f6f3;
            --info-text: #145a32;
        }
        
        body {
            font-family: 'Cairo', sans-serif;
            background-color: #f4f6f8;
            margin: 0;
            padding: 20px;
            color: #333;
            direction: rtl;
        }

        .upload-area {
            text-align: center;
            padding: 40px;
            border: 2px dashed #bdc3c7;
            background: #fff;
            border-radius: 12px;
            margin: 0 auto 30px auto;
            max-width: 800px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }

        /* Ø­Ø§ÙˆÙŠØ© Ø§Ù„ØµÙØ­Ø© A4 */
        .page-container {
            width: 210mm;
            min-height: 297mm;
            margin: 0 auto;
            background: #fff;
            padding: 10mm;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
        }

        /* 1. Ø§Ù„ØªØ±ÙˆÙŠØ³Ø© */
        .header-section {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            border-bottom: 3px solid var(--primary-color);
            padding-bottom: 10px;
            margin-bottom: 15px;
            font-size: 11px;
            line-height: 1.4;
        }
        .header-right { text-align: right; width: 30%; }
        .header-left { text-align: left; width: 30%; direction: ltr; }
        
        .header-center { 
            text-align: center; 
            width: 40%; 
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .school-name-ar { font-weight: bold; font-size: 14px; margin-bottom: 2px; }
        .school-name-en { font-size: 12px; color: #555; font-weight: 600; margin-bottom: 5px; }
        .report-title { 
            font-weight: bold; 
            font-size: 18px; /* ØªÙƒØ¨ÙŠØ± Ø§Ù„Ø®Ø· Ù‚Ù„ÙŠÙ„Ø§Ù‹ */
            color: var(--primary-color); 
            text-decoration: underline;
            margin-top: 10px;
            margin-bottom: 5px;
        }

        /* 2. Ø´Ø±ÙŠØ· Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª */
        .info-bar {
            background-color: var(--info-bg);
            color: var(--info-text);
            border: 1px solid #d1f2eb;
            padding: 8px 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-around;
            align-items: center;
            font-weight: bold;
            font-size: 13px;
        }
        .info-item span {
            color: #0e6655;
            margin-left: 5px;
        }

        /* 3. Ø§Ù„Ø¬Ø¯ÙˆÙ„ */
        .table-section { margin-bottom: 20px; }
        table { width: 100%; border-collapse: collapse; font-size: 10px; }
        th, td { border: 1px solid #bbb; padding: 4px; text-align: center; }
        
        .main-header th { background-color: var(--primary-color); color: #fff; }
        .sub-header th { background-color: #f2f3f4; color: #333; font-size: 9px; }
        .col-separator { border-left: 2px solid #555 !important; }
        tr:nth-child(even) { background-color: #fafafa; }

        /* 4. Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ */
        .chart-section {
            flex-grow: 1;
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 10px;
            display: flex;
            flex-direction: column;
        }
        .chart-container {
            position: relative;
            flex-grow: 1;
            width: 100%;
            min-height: 300px;
        }

        /* Ø§Ù„Ø£Ø²Ø±Ø§Ø± */
        .actions { text-align: center; margin-top: 30px; padding-bottom: 40px; }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            color: #fff;
            cursor: pointer;
            font-family: 'Cairo', sans-serif;
            margin: 0 5px;
            font-size: 14px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: transform 0.1s;
        }
        .btn:hover { transform: translateY(-2px); opacity: 0.9; }
        .btn-upload { background-color: #3498db; }
        .btn-print { background-color: var(--primary-color); }
        .btn-excel { background-color: #27ae60; }
        .btn-img { background-color: #8e44ad; }

        /* ØªØ­Ø³ÙŠÙ†Ø§Øª Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© */
        @media print {
            body { 
                background: none; 
                padding: 0; 
                margin: 0; 
            }
            /* Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø£Ø²Ø±Ø§Ø± ÙˆÙ…Ù†Ø·Ù‚Ø© Ø§Ù„Ø±ÙØ¹ Ø¨Ù‚ÙˆØ© */
            .upload-area, .actions, .btn { 
                display: none !important; 
            }
            .page-container { 
                box-shadow: none; 
                margin: 0; 
                width: 100%; 
                max-width: 100%;
                padding: 5mm;
                height: auto; /* Ø§Ù„Ø³Ù…Ø§Ø­ Ù„Ù„ØµÙØ­Ø© Ø¨Ø£Ø®Ø° Ø·ÙˆÙ„Ù‡Ø§ Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠ */
            }
            /* Ø¶Ù…Ø§Ù† Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø£Ù„ÙˆØ§Ù† ÙˆØ§Ù„Ø®Ù„ÙÙŠØ§Øª */
            .info-bar { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; background-color: #e8f6f3 !important; }
            .main-header th { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; background-color: #2c3e50 !important; color: #fff !important; }
            
            /* Ù…Ù†Ø¹ ØªÙ‚Ø³ÙŠÙ… Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…Ù‡Ù…Ø© Ø¨ÙŠÙ† Ø§Ù„ØµÙØ­Ø§Øª */
            .table-section, .chart-section, .info-bar {
                page-break-inside: avoid;
            }
        }
    </style>
</head>
<body>

<div class="upload-area">
    <h2>ğŸ“Š Ù†Ø¸Ø§Ù… ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠ</h2>
    <p>Ù‚Ù… Ø¨Ø±ÙØ¹ Ù…Ù„Ù Ø§Ù„Ø¥ÙƒØ³Ù„ (XLSX) Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„ØªÙ‚Ø±ÙŠØ± ÙÙˆØ±Ø§Ù‹</p>
    <button class="btn btn-upload" onclick="document.getElementById('fileUpload').click()">ğŸ“‚ Ø±ÙØ¹ Ù…Ù„Ù Ø§Ù„Ø¥ÙƒØ³Ù„</button>
    <input type="file" id="fileUpload" accept=".xlsx, .xls" style="display: none;" onchange="handleFile(this)">
</div>

<div class="page-container" id="reportContainer" style="display: none;">
    
    <div class="header-section">
        <div class="header-right" id="headerRight"></div>
        <div class="header-center">
            <div class="school-name-ar" id="schoolNameAr"></div>
            <div class="school-name-en" id="schoolNameEn"></div>
            <div class="report-title">ØªÙ‚Ø±ÙŠØ± ØªØ­Ù„ÙŠÙ„ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø·Ù„Ø§Ø¨</div>
            </div>
        <div class="header-left" id="headerLeft"></div>
    </div>

    <div class="info-bar">
        <div class="info-item"><span>ğŸ“Œ Ø§Ù„ØµÙ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ:</span> <span id="gradeName">--</span></div>
        <div class="info-item"><span>ğŸ« Ø§Ù„ÙØµÙ„ / Ø§Ù„Ø´Ø¹Ø¨Ø©:</span> <span id="sectionName">--</span></div>
        <div class="info-item"><span>ğŸ‘¥ Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨:</span> <span id="totalStudents">--</span></div>
    </div>

    <div class="table-section">
        <table id="combinedTable">
            <thead>
                <tr class="main-header">
                    <th rowspan="2" style="width: 18%;">Ø§Ù„Ù…Ø§Ø¯Ø© Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©</th>
                    <th colspan="5" class="col-separator" style="border-left: 2px solid #fff;">Ø§Ù„Ø£Ø¹Ø¯Ø§Ø¯ (Counts)</th>
                    <th colspan="5">Ø§Ù„Ù†Ø³Ø¨ Ø§Ù„Ù…Ø¦ÙˆÙŠØ© (Percentages)</th>
                </tr>
                <tr class="sub-header">
                    <th>Ø¶Ø¹ÙŠÙ</th>
                    <th>Ù…Ù‚Ø¨ÙˆÙ„</th>
                    <th>Ø¬ÙŠØ¯</th>
                    <th>Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹</th>
                    <th class="col-separator" style="border-left: 2px solid #999;">Ù…Ù…ØªØ§Ø²</th>
                    
                    <th>Ø¶Ø¹ÙŠÙ</th>
                    <th>Ù…Ù‚Ø¨ÙˆÙ„</th>
                    <th>Ø¬ÙŠØ¯</th>
                    <th>Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹</th>
                    <th>Ù…Ù…ØªØ§Ø²</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <div class="chart-section">
        <div class="chart-container">
            <canvas id="gradesChart"></canvas>
        </div>
    </div>

</div>

<div class="actions" id="actionButtons" style="display: none;">
    <button class="btn btn-print" onclick="window.print()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
    <button class="btn btn-excel" onclick="exportToExcel()">ğŸ“¥ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥ÙƒØ³Ù„</button>
    <button class="btn btn-img" onclick="downloadChartImage()">ğŸ–¼ï¸ Ø­ÙØ¸ Ø§Ù„Ø±Ø³Ù…</button>
</div>

<script>
    let globalCounts = {};
    let globalTotalStudents = 0;
    let globalSubjects = [];
    const gradesOrder = ["Ø¶Ø¹ÙŠÙ", "Ù…Ù‚Ø¨ÙˆÙ„", "Ø¬ÙŠØ¯", "Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹", "Ù…Ù…ØªØ§Ø²"];

    function toArabicNumerals(str) {
        if (str === null || str === undefined) return "";
        str = str.toString();
        const map = ["Ù ", "Ù¡", "Ù¢", "Ù£", "Ù¤", "Ù¥", "Ù¦", "Ù§", "Ù¨", "Ù©"];
        return str.replace(/[0-9]/g, d => map[d]);
    }

    function handleFile(input) {
        const file = input.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, {type: 'array'});
            
            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
            
            // 1. Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„ØªØ±ÙˆÙŠØ³Ø©
            const metaData = extractMetaData(firstSheet);
            renderHeader(metaData);

            // 2. Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¯Ø±Ø¬Ø§Øª
            processData(workbook);
        };
        reader.readAsArrayBuffer(file);
    }

    function extractMetaData(sheet) {
        const json = XLSX.utils.sheet_to_json(sheet, {header: 1});
        const meta = {
            rightLines: [],
            leftLines: [],
            schoolAr: "Ù…Ø¯Ø±Ø³Ø© ...",
            schoolEn: "School Name",
            grade: "ØºÙŠØ± Ù…Ø­Ø¯Ø¯",
            section: "1" // Ù‚ÙŠÙ…Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
        };

        const limit = Math.min(json.length, 35);
        
        for (let i = 0; i < limit; i++) {
            const row = json[i];
            if (!row) continue;

            row.forEach(cell => {
                if (typeof cell !== 'string') return;
                const txt = cell.trim();
                if (!txt) return;

                // Ø§Ù„ØªØ±ÙˆÙŠØ³Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©
                if (txt.includes("Ø§Ù„Ù…Ù…Ù„ÙƒØ©") || txt.includes("ÙˆØ²Ø§Ø±Ø©") || txt.includes("Ø¥Ø¯Ø§Ø±Ø©")) meta.rightLines.push(txt);
                else if (txt.toLowerCase().includes("kingdom") || txt.toLowerCase().includes("ministry") || txt.toLowerCase().includes("directorate")) meta.leftLines.push(txt);
                
                // Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³Ø©
                if (txt.toLowerCase().includes("school") && !txt.toLowerCase().includes("principal")) {
                    meta.schoolEn = txt;
                }
                if ((txt.includes("Ù…Ø¯Ø±Ø³Ø©") || txt.includes("Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠØ©") || txt.includes("Ø«Ø§Ù†ÙˆÙŠØ©")) && !txt.includes("Ù…Ø¯ÙŠØ±")) {
                    if (!meta.rightLines.includes(txt)) meta.schoolAr = txt;
                }

                // Ø§Ù„ØµÙ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ
                if (i >= 15 && i <= 20) {
                    if (txt.includes("Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ") || txt.includes("Ø§Ù„Ù…ØªÙˆØ³Ø·") || txt.includes("Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ")) {
                        meta.grade = txt;
                    }
                }
            });
        }
        
        // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ÙØµÙ„ (Ù…Ø­Ø§ÙˆÙ„Ø© Ø¹Ø§Ù…Ø©)
        // Ù†Ø­Ø§ÙˆÙ„ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù†Ù…Ø· "Ø§Ù„ØµÙ : ..." Ø£Ùˆ "Ø§Ù„ÙØµÙ„ : ..." ÙÙŠ Ø±Ø£Ø³ Ø§Ù„Ø¬Ø¯ÙˆÙ„
        for(let i=0; i<30; i++) {
             if(!json[i]) continue;
             for(let j=0; j<json[i].length; j++) {
                 let val = (json[i][j] || "").toString();
                 if(val.includes("Ø§Ù„ÙØµÙ„") && val.length < 15) { 
                     // Ø¥Ø°Ø§ ÙˆØ¬Ø¯Ù†Ø§ ÙƒÙ„Ù…Ø© ÙØµÙ„ ÙˆÙ‚ÙŠÙ…Ø© Ù‚ØµÙŠØ±Ø© Ø¨Ø¬ÙˆØ§Ø±Ù‡Ø§
                     // Ù‡Ø°Ù‡ Ù…Ø­Ø§ÙˆÙ„Ø© Ø¨Ø³ÙŠØ·Ø©ØŒ Ù„ÙƒÙ† Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© "1" Ù…ÙˆØ¬ÙˆØ¯Ø©
                 }
             }
        }
        
        meta.rightLines = [...new Set(meta.rightLines)];
        meta.leftLines = [...new Set(meta.leftLines)];

        return meta;
    }

    function renderHeader(meta) {
        document.getElementById('headerRight').innerHTML = meta.rightLines.join('<br>');
        document.getElementById('headerLeft').innerHTML = meta.leftLines.join('<br>');
        document.getElementById('schoolNameAr').innerText = meta.schoolAr;
        document.getElementById('schoolNameEn').innerText = meta.schoolEn;
        
        document.getElementById('gradeName').innerText = meta.grade;
        document.getElementById('sectionName').innerText = meta.section;

        document.getElementById('reportContainer').style.display = 'flex';
        document.getElementById('actionButtons').style.display = 'block';
    }

    function processData(workbook) {
        globalSubjects = [
             "Ø§Ù„Ù‚Ø±Ø¢Ù† Ø§Ù„ÙƒØ±ÙŠÙ… ÙˆØ§Ù„Ø¯Ø±Ø§Ø³Ø§Øª Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠØ©", "Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©", "Ø§Ù„Ø¯Ø±Ø§Ø³Ø§Øª Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ©",
             "Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª", "Ø§Ù„Ø¹Ù„ÙˆÙ…", "Ø§Ù„Ù…Ù‡Ø§Ø±Ø§Øª Ø§Ù„Ø±Ù‚Ù…ÙŠØ©", "Ø§Ù„ØªØ±Ø¨ÙŠØ© Ø§Ù„ÙÙ†ÙŠØ©",
             "Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©", "Ø§Ù„Ù…Ù‡Ø§Ø±Ø§Øª Ø§Ù„Ø­ÙŠØ§ØªÙŠØ© ÙˆØ§Ù„Ø£Ø³Ø±ÙŠØ©", "Ø§Ù„ØªØ±Ø¨ÙŠØ© Ø§Ù„Ø¨Ø¯Ù†ÙŠØ© ÙˆØ§Ù„Ø¯ÙØ§Ø¹ Ø¹Ù† Ø§Ù„Ù†ÙØ³"
        ];
        
        globalCounts = {};
        globalSubjects.forEach(s => globalCounts[s] = { "Ø¶Ø¹ÙŠÙ": 0, "Ù…Ù‚Ø¨ÙˆÙ„": 0, "Ø¬ÙŠØ¯": 0, "Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹": 0, "Ù…Ù…ØªØ§Ø²": 0 });
        globalTotalStudents = 0;

        workbook.SheetNames.forEach(sheetName => {
            const sheet = workbook.Sheets[sheetName];
            const json = XLSX.utils.sheet_to_json(sheet, {header: 1});
            if (json.length < 20) return;

            let startRow = -1;
            for(let r=0; r < Math.min(json.length, 60); r++) {
                if(json[r]) {
                    for(let c=0; c < json[r].length; c++) {
                         if (typeof json[r][c] === 'string' && (json[r][c].includes("The Holy Qur'an") || json[r][c].includes("Ø§Ù„Ù‚Ø±Ø¢Ù† Ø§Ù„ÙƒØ±ÙŠÙ…"))) {
                             startRow = r;
                             break;
                         }
                    }
                }
                if(startRow !== -1) break;
            }

            if (startRow !== -1) {
                globalTotalStudents++;
                const gradeCol = 23; 
                for (let i=0; i<globalSubjects.length; i++) {
                    const rowIdx = startRow + i;
                    if(rowIdx < json.length) {
                        const subjectName = globalSubjects[i];
                        let grade = json[rowIdx][gradeCol];
                        if (typeof grade === 'string') {
                            grade = grade.trim();
                            if (globalCounts[subjectName] && globalCounts[subjectName][grade] !== undefined) {
                                globalCounts[subjectName][grade]++;
                            }
                        }
                    }
                }
            }
        });

        if (globalTotalStudents > 0) {
            document.getElementById('totalStudents').innerText = toArabicNumerals(globalTotalStudents);
            renderCombinedTable();
            renderChart();
        }
    }

    function renderCombinedTable() {
        const tbody = document.querySelector('#combinedTable tbody');
        tbody.innerHTML = "";

        globalSubjects.forEach(subject => {
            let tr = `<tr>`;
            tr += `<td style="font-weight:bold; text-align:right;">${subject}</td>`;
            
            gradesOrder.forEach((g, idx) => {
                const val = globalCounts[subject][g];
                const borderStyle = (idx === gradesOrder.length - 1) ? 'border-left: 2px solid #999;' : '';
                tr += `<td style="${borderStyle}">${toArabicNumerals(val)}</td>`;
            });

            gradesOrder.forEach(g => {
                const val = globalCounts[subject][g];
                const pct = globalTotalStudents > 0 ? ((val/globalTotalStudents)*100).toFixed(1) : "0";
                tr += `<td>${toArabicNumerals(pct)}%</td>`;
            });

            tr += `</tr>`;
            tbody.innerHTML += tr;
        });
    }

    function renderChart() {
        const ctx = document.getElementById('gradesChart').getContext('2d');
        const colors = { "Ù…Ù…ØªØ§Ø²": "#27ae60", "Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹": "#2980b9", "Ø¬ÙŠØ¯": "#f1c40f", "Ù…Ù‚Ø¨ÙˆÙ„": "#e67e22", "Ø¶Ø¹ÙŠÙ": "#c0392b" };

        const datasets = gradesOrder.reverse().map(g => ({
            label: g,
            data: globalSubjects.map(s => globalCounts[s][g]),
            backgroundColor: colors[g],
            borderWidth: 1
        }));

        if (window.myChart) window.myChart.destroy();
        Chart.defaults.font.family = "'Cairo', sans-serif";
        
        window.myChart = new Chart(ctx, {
            type: 'bar',
            data: { labels: globalSubjects, datasets: datasets },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: { ticks: { font: { size: 11, weight: 'bold' } }, grid: { display: false } },
                    y: { position: 'right', ticks: { callback: v => toArabicNumerals(v) }, title: { display: true, text: 'Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨' } }
                },
                plugins: {
                    legend: { position: 'top', rtl: true },
                    title: { display: true, text: 'ØªÙˆØ²ÙŠØ¹ ØªÙ‚Ø¯ÙŠØ±Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨ Ø­Ø³Ø¨ Ø§Ù„Ù…ÙˆØ§Ø¯' }
                }
            }
        });
    }

    function exportToExcel() {
        if (globalTotalStudents === 0) return;
        let dataForExcel = [];
        
        globalSubjects.forEach(subject => {
            let rowObj = { "Ø§Ù„Ù…Ø§Ø¯Ø©": subject };
            gradesOrder.forEach(g => rowObj[`Ø¹Ø¯Ø¯ (${g})`] = globalCounts[subject][g]);
            gradesOrder.forEach(g => {
                const val = globalCounts[subject][g];
                rowObj[`Ù†Ø³Ø¨Ø© (${g}) %`] = globalTotalStudents > 0 ? ((val/globalTotalStudents)*100).toFixed(1)+"%" : "0%";
            });
            dataForExcel.push(rowObj);
        });

        const ws = XLSX.utils.json_to_sheet(dataForExcel);
        const wscols = [{wch: 25}]; 
        for(let i=0; i<10; i++) wscols.push({wch: 10});
        ws['!cols'] = wscols;

        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Ø§Ù„ØªØ­Ù„ÙŠÙ„");
        XLSX.writeFile(wb, "ØªØ­Ù„ÙŠÙ„_Ø§Ù„Ù†ØªØ§Ø¦Ø¬.xlsx");
    }

    function downloadChartImage() {
        const canvas = document.getElementById('gradesChart');
        const link = document.createElement('a');
        link.download = 'chart-analysis.png';
        link.href = canvas.toDataURL('image/png', 1.0);
        link.click();
    }
</script>

</body>
</html>