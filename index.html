<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø¯ÙŠØ± Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ù„ØªÙ‚Ù‰ - Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¹Ù„Ù…</title>
    <link rel="icon" href="data:,">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary-color: #007bff; --secondary-color: #1a73e8; --bg-color: #f4f7f6;
            --panel-bg: #ffffff; --border-color: #e0e4e7; --text-color: #333d47;
            --light-text: #707b85; --hover-bg: #f0f3f5; --danger: #dc3545; --success: #28a745;
        }
        body.dark-mode {
            --bg-color: #121212; --panel-bg: #1e1e1e; --border-color: #333333;
            --text-color: #e0e0e0; --light-text: #b0b0b0; --hover-bg: #2a2a2a;
        }

        body { font-family: "Cairo", sans-serif; margin: 0; background-color: var(--bg-color); color: var(--text-color); height: 100vh; overflow: hidden; display: flex; transition: 0.3s; }
        .container { display: flex; width: 100%; height: 100%; }

        /* Sidebar & Controls */
        .sidebar { width: 400px; min-width: 320px; background-color: var(--panel-bg); border-left: 1px solid var(--border-color); display: flex; flex-direction: column; box-shadow: 0 4px 12px rgba(0,0,0,0.05); z-index: 10; }
        .sidebar-header { padding: 15px; border-bottom: 1px solid var(--border-color); display: flex; flex-direction: column; gap: 10px; background: var(--panel-bg); }
        .top-row { display: flex; justify-content: space-between; align-items: center; }
        
        .control-panel { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 5px; }
        .btn { border: none; padding: 8px; border-radius: 6px; cursor: pointer; font-family: inherit; font-size: 0.9em; font-weight: bold; display: flex; align-items: center; justify-content: center; gap: 5px; transition: 0.2s; color: white; text-decoration: none; }
        .btn-upload { background: var(--success); grid-column: span 2; }
        .btn-refresh { background: var(--secondary-color); }
        .btn-logout { background: var(--light-text); }
        .btn:hover { opacity: 0.9; transform: translateY(-1px); }

        .search-box { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--border-color); background: var(--hover-bg); color: var(--text-color); box-sizing: border-box; font-family: inherit; }

        /* Table Styles */
        .table-container { overflow-y: auto; flex: 1; padding: 0 10px; }
        #file-table { width: 100%; border-collapse: separate; border-spacing: 0 5px; }
        #file-table tbody tr { cursor: pointer; background: var(--panel-bg); transition: 0.2s; border-radius: 6px; }
        #file-table tbody tr:hover { background: var(--hover-bg); transform: translateX(-3px); }
        #file-table tbody tr.active { background: var(--primary-color); color: white; }
        #file-table tbody tr.active i { color: white !important; }
        
        #file-table td { padding: 10px; vertical-align: middle; border-bottom: 1px solid var(--border-color); }
        .col-icon { width: 30px; text-align: center; font-size: 1.2em; }
        .col-actions { text-align: left; width: 60px; }
        .action-icon { cursor: pointer; margin: 0 5px; opacity: 0.6; transition: 0.2s; }
        .action-icon:hover { opacity: 1; transform: scale(1.2); }
        .delete-icon:hover { color: var(--danger); }
        .edit-icon:hover { color: var(--secondary-color); }

        .folder-header { background: var(--hover-bg) !important; font-weight: bold; color: var(--primary-color); }
        
        /* Viewer */
        .main-content { flex: 1; padding: 20px; display: flex; flex-direction: column; background: var(--bg-color); }
        .viewer-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding: 10px; background: var(--panel-bg); border-radius: 8px; border: 1px solid var(--border-color); }
        .header-actions { display: flex; gap: 10px; }
        #viewer { flex: 1; background: var(--panel-bg); border-radius: 12px; border: 1px solid var(--border-color); overflow: hidden; position: relative; display: flex; align-items: center; justify-content: center; }
        iframe, video, img { width: 100%; height: 100%; border: none; object-fit: contain; }

        /* Modals */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; backdrop-filter: blur(4px); }
        .modal-content { background: var(--panel-bg); margin: 15vh auto; padding: 25px; width: 90%; max-width: 400px; border-radius: 15px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.2); animation: slideDown 0.3s; }
        @keyframes slideDown { from {transform: translateY(-20px); opacity: 0;} to {transform: translateY(0); opacity: 1;} }
        
        .modal input { width: 100%; padding: 12px; margin: 15px 0; border: 1px solid var(--border-color); border-radius: 8px; box-sizing: border-box; background: var(--bg-color); color: var(--text-color); }
        .modal-buttons { display: flex; gap: 10px; margin-top: 15px; }

        #loader { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); z-index: 3000; justify-content: center; align-items: center; flex-direction: column; color: var(--primary-color); font-weight: bold; }
        
        @media (max-width: 768px) { .container { flex-direction: column; } .sidebar { width: 100%; height: 50vh; } }
    </style>
</head>
<body>

    <div id="authModal" class="modal" style="display: flex;">
        <div class="modal-content">
            <i class="fa-solid fa-lock fa-3x" style="color: var(--primary-color);"></i>
            <h3>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h3>
            <p>Ø£Ø¯Ø®Ù„ Ø±Ù…Ø² Ø§Ù„ÙˆØµÙˆÙ„ (GitHub Token)</p>
            <form onsubmit="saveToken(); return false;">
                <input type="text" name="username" autocomplete="username" style="display:none;">
                <input type="password" id="tokenInput" autocomplete="current-password" placeholder="ghp_xxxxxxxxxxxx" style="text-align: center;">
                <button type="submit" class="btn btn-upload" style="width:100%">Ø¯Ø®ÙˆÙ„</button>
            </form>
        </div>
    </div>

    <div id="renameModal" class="modal">
        <div class="modal-content">
            <h3>ØªØºÙŠÙŠØ± Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù</h3>
            <input type="text" id="renameInput">
            <div class="modal-buttons">
                <button class="btn btn-upload" onclick="executeRename()" style="flex:1">Ø­ÙØ¸</button>
                <button class="btn btn-logout" onclick="closeModal('renameModal')" style="flex:1">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
        </div>
    </div>

    <div id="uploadModal" class="modal">
        <div class="modal-content">
            <h3>Ø±ÙØ¹ Ù…Ù„Ù Ø¬Ø¯ÙŠØ¯</h3>
            <input type="file" id="fileInput" style="padding: 10px;">
            <input type="text" id="folderNameInput" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø¬Ù„Ø¯ (Ù…Ø«Ø§Ù„: ØªØ¹Ø§Ù…ÙŠÙ…)">
            <div class="modal-buttons">
                <button class="btn btn-upload" onclick="executeUpload()" style="flex:1">Ø±ÙØ¹</button>
                <button class="btn btn-logout" onclick="closeModal('uploadModal')" style="flex:1">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
        </div>
    </div>

    <div id="loader"><i class="fas fa-spinner fa-spin fa-3x"></i><p style="margin-top:10px">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙ†ÙÙŠØ°...</p></div>

    <div class="container">
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="top-row">
                    <h3>ğŸ“‚ Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ù„ØªÙ‚Ù‰</h3>
                    <i class="fa-solid fa-moon" id="themeIcon" style="cursor: pointer;" onclick="toggleTheme()"></i>
                </div>
                
                <div class="control-panel">
                    <button class="btn btn-upload" onclick="openModal('uploadModal')"><i class="fa-solid fa-cloud-arrow-up"></i> Ø±ÙØ¹ Ù…Ù„Ù</button>
                    <button class="btn btn-refresh" onclick="fetchFiles()"><i class="fa-solid fa-rotate"></i> ØªØ­Ø¯ÙŠØ«</button>
                    <button class="btn btn-logout" onclick="logout()"><i class="fa-solid fa-sign-out-alt"></i> Ø®Ø±ÙˆØ¬</button>
                </div>

                <input type="text" id="searchInput" class="search-box" placeholder="ğŸ” Ø¨Ø­Ø« Ø³Ø±ÙŠØ¹..." oninput="filterFiles()">
            </div>

            <div class="table-container">
                <table id="file-table">
                    <tbody id="file-list-body"></tbody>
                </table>
            </div>
        </aside>

        <main class="main-content">
            <div class="viewer-header">
                <h3 id="currentFileName" style="margin:0">Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù</h3>
                <div class="header-actions">
                    <a id="openNewTabBtn" href="#" target="_blank" class="btn btn-refresh" style="display: none; width: auto;">
                        <i class="fa-solid fa-up-right-from-square"></i> ÙØªØ­
                    </a>
                    <a id="downloadBtn" href="#" target="_blank" class="btn btn-upload" style="display: none; padding: 5px 15px; width: auto;">
                        <i class="fa-solid fa-download"></i> ØªØ­Ù…ÙŠÙ„
                    </a>
                </div>
            </div>
            <div id="viewer">
                <div style="text-align: center; color: var(--light-text);">
                    <i class="fa-regular fa-folder-open fa-4x"></i>
                    <p>Ø§Ø®ØªØ± Ù…Ù„ÙØ§Ù‹ Ù„Ù„Ø¹Ø±Ø¶</p>
                </div>
            </div>
        </main>
    </div>

    <script>
        // ================= Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„ =================
        const CONFIG = {
            owner: 'ensanbinadam',   
            repo: 'doc_viewer',     
            path: 'documents',      
            branch: 'main'
        };

        let allFiles = []; // Ø§Ù„Ù…ØªØºÙŠØ± Ø§Ù„Ø°ÙŠ ÙŠØ­Ù…Ù„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­ÙŠØ©
        let renameTargetName = null; // Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø§Ø³Ù… ÙÙ‚Ø· ÙƒÙ…Ø±Ø¬Ø¹

        function getLiveUrl(filename) {
            return `https://${CONFIG.owner}.github.io/${CONFIG.repo}/${CONFIG.path}/${encodeURIComponent(filename)}`;
        }

        document.addEventListener("DOMContentLoaded", () => {
            if(localStorage.getItem('gh_token')) {
                document.getElementById('authModal').style.display = 'none';
                fetchFiles();
            }
            if(localStorage.getItem('dark-mode') === 'true') toggleTheme();
        });

        function saveToken() {
            const t = document.getElementById('tokenInput').value.trim();
            if(t) { localStorage.setItem('gh_token', t); document.getElementById('authModal').style.display = 'none'; fetchFiles(); }
        }
        function logout() { localStorage.removeItem('gh_token'); location.reload(); }
        function openModal(id) { document.getElementById(id).style.display = 'block'; }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        function showLoader(show) { document.getElementById('loader').style.display = show ? 'flex' : 'none'; }

        async function apiRequest(endpoint, method = 'GET', body = null) {
            const token = localStorage.getItem('gh_token');
            const headers = { 
                'Authorization': `token ${token}`,
                'Accept': 'application/vnd.github.v3+json',
                'Content-Type': 'application/json'
            };
            const options = { method, headers };
            if (body) options.body = JSON.stringify(body);

            // Ø¥Ø¶Ø§ÙØ© ÙƒØ§Ø´ Ø¨Ø§Ø³ØªØ± Ù„Ù…Ù†Ø¹ Ø§Ù„Ù…ØªØµÙØ­ Ù…Ù† Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ù‚Ø¯ÙŠÙ…Ø©
            const timestamp = new Date().getTime();
            const url = `https://api.github.com/repos/${CONFIG.owner}/${CONFIG.repo}/${endpoint}${endpoint.includes('?') ? '&' : '?'}t=${timestamp}`;

            const res = await fetch(url, options);
            if (!res.ok) {
                const err = await res.json();
                throw new Error(err.message || `Error ${res.status}`);
            }
            return res.json();
        }

        async function fetchFiles() {
            const listBody = document.getElementById('file-list-body');
            // Ù„Ø§ Ù†Ù…Ø³Ø­ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ ØªØ­Ø¯ÙŠØ« ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ© Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù„ØªØ¬Ø±Ø¨Ø©ØŒ Ø¥Ù„Ø§ ÙÙŠ Ø£ÙˆÙ„ Ù…Ø±Ø©
            if(allFiles.length === 0) listBody.innerHTML = '<tr><td colspan="3" style="text-align:center">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr>';
            
            try {
                const data = await apiRequest(`contents/${CONFIG.path}?ref=${CONFIG.branch}`);
                allFiles = Array.isArray(data) ? data : [];
                renderTable(allFiles);
            } catch (e) {
                listBody.innerHTML = `<tr><td colspan="3" style="color:red; text-align:center">Ø®Ø·Ø£: ${e.message}</td></tr>`;
            }
        }

        function renderTable(files) {
            const listBody = document.getElementById('file-list-body');
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            listBody.innerHTML = '';
            const folders = {};
            files.forEach(file => {
                if (file.type !== 'file') return;
                const match = file.name.match(/^\[(.*?)\]\s*(.*)/);
                const folderName = match ? match[1] : 'Ù…Ù„ÙØ§Øª Ø¹Ø§Ù…Ø©';
                const cleanName = match ? match[2] : file.name;
                if (searchTerm && !file.name.toLowerCase().includes(searchTerm)) return;
                if (!folders[folderName]) folders[folderName] = [];
                folders[folderName].push({ ...file, cleanName });
            });

            Object.keys(folders).sort().forEach(folder => {
                const headerRow = document.createElement('tr');
                headerRow.className = 'folder-header';
                headerRow.innerHTML = `<td colspan="3"><i class="fa-solid fa-folder-open"></i> ${folder} (${folders[folder].length})</td>`;
                listBody.appendChild(headerRow);
                folders[folder].forEach(file => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td class="col-icon"><i class="${getFileIcon(file.name)}"></i></td>
                        <td>${file.cleanName}</td>
                        <td class="col-actions">
                            <i class="fa-solid fa-pen action-icon edit-icon" onclick="promptRename('${file.name}', event)"></i>
                            <i class="fa-solid fa-trash action-icon delete-icon" onclick="deleteFile('${file.name}', event)"></i>
                        </td>
                    `;
                    tr.onclick = (e) => {
                        if(e.target.classList.contains('action-icon')) return;
                        document.querySelectorAll('tr').forEach(r => r.classList.remove('active'));
                        tr.classList.add('active');
                        loadFileViewer(file);
                    };
                    listBody.appendChild(tr);
                });
            });
        }

        // ================= Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù…ØµØ­Ø­Ø© =================

        // Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø£Ø­Ø¯Ø« SHA Ù„Ù„Ù…Ù„Ù Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­Ù…Ù„Ø©
        function getLatestSha(filename) {
            const file = allFiles.find(f => f.name === filename);
            return file ? file.sha : null;
        }

        async function executeUpload() {
            const fileInput = document.getElementById('fileInput');
            const folderInput = document.getElementById('folderNameInput');
            const file = fileInput.files[0];
            if (!file) return alert('Ø§Ø®ØªØ± Ù…Ù„ÙØ§Ù‹ Ø£ÙˆÙ„Ø§Ù‹');
            let folder = folderInput.value.trim() || 'Ù…Ù„ÙØ§Øª Ø¹Ø§Ù…Ø©';
            const fileName = `[${folder}] ${file.name}`;
            
            showLoader(true);
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = async () => {
                const content = reader.result.split(',')[1];
                try {
                    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ù„Ù Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹ Ù…Ø³Ø¨Ù‚Ø§Ù‹ Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ SHA (Ù„Ù„ØªØ­Ø¯ÙŠØ« Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø§Ù„Ø®Ø·Ø£)
                    const existingSha = getLatestSha(fileName); 
                    
                    const body = {
                        message: `Upload ${fileName}`,
                        content: content,
                        branch: CONFIG.branch
                    };
                    // Ø¥Ø°Ø§ Ø§Ù„Ù…Ù„Ù Ù…ÙˆØ¬ÙˆØ¯ØŒ Ù†Ø±Ø³Ù„ Ø§Ù„Ù€ SHA Ù„ÙŠØªÙ… Ø§Ø³ØªØ¨Ø¯Ø§Ù„Ù‡
                    if (existingSha) body.sha = existingSha;

                    await apiRequest(`contents/${CONFIG.path}/${encodeURIComponent(fileName)}`, 'PUT', body);
                    
                    closeModal('uploadModal');
                    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙÙˆØ±Ø§Ù‹
                    await fetchFiles(); 
                    alert('ØªÙ… Ø§Ù„Ø±ÙØ¹ Ø¨Ù†Ø¬Ø§Ø­');
                } catch (e) { alert("ÙØ´Ù„ Ø§Ù„Ø±ÙØ¹: " + e.message); }
                showLoader(false);
            };
        }

        async function deleteFile(name, event) {
            event.stopPropagation();
            if (!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù: ${name}ØŸ`)) return;
            
            showLoader(true);
            try {
                // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† SHA Ø§Ù„Ø·Ø§Ø²Ø¬ Ø§Ù„Ø¢Ù†
                const sha = getLatestSha(name);
                if (!sha) throw new Error("Ø§Ù„Ù…Ù„Ù ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ø¯ÙŠØ«");

                await apiRequest(`contents/${CONFIG.path}/${encodeURIComponent(name)}`, 'DELETE', {
                    message: `Delete ${name}`,
                    sha: sha, 
                    branch: CONFIG.branch
                });
                await fetchFiles(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
            } catch (e) { alert("ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù: " + e.message); }
            showLoader(false);
        }

        function promptRename(name, event) {
            event.stopPropagation();
            renameTargetName = name; // Ù†Ø®Ø²Ù† Ø§Ù„Ø§Ø³Ù… ÙÙ‚Ø·
            document.getElementById('renameInput').value = name;
            openModal('renameModal');
        }

        async function executeRename() {
            const newName = document.getElementById('renameInput').value.trim();
            if (!newName || newName === renameTargetName) return;
            
            showLoader(true);
            try {
                // 1. Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù‚Ø¯ÙŠÙ… ÙˆØ§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§ØªÙ‡
                const oldFileRes = await apiRequest(`contents/${CONFIG.path}/${encodeURIComponent(renameTargetName)}`);
                const currentSha = oldFileRes.sha; // SHA Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ± Ù…Ø¨Ø§Ø´Ø±Ø©

                // 2. Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø¬Ø¯ÙŠØ¯
                await apiRequest(`contents/${CONFIG.path}/${encodeURIComponent(newName)}`, 'PUT', {
                    message: `Rename to ${newName}`,
                    content: oldFileRes.content,
                    branch: CONFIG.branch
                });

                // 3. Ø­Ø°Ù Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù‚Ø¯ÙŠÙ… Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù€ SHA Ø§Ù„Ø°ÙŠ Ø¬Ù„Ø¨Ù†Ø§Ù‡ Ù„Ù„ØªÙˆ
                await apiRequest(`contents/${CONFIG.path}/${encodeURIComponent(renameTargetName)}`, 'DELETE', {
                    message: `Delete old file`,
                    sha: currentSha,
                    branch: CONFIG.branch
                });

                closeModal('renameModal');
                await fetchFiles();
            } catch (e) { alert("ÙØ´Ù„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: " + e.message); }
            showLoader(false);
        }

        // ================= Ø§Ù„Ø¹Ø§Ø±Ø¶ =================
        function loadFileViewer(file) {
            const viewer = document.getElementById('viewer');
            const ext = file.name.split('.').pop().toLowerCase();
            const liveUrl = getLiveUrl(file.name);
            const downloadUrl = file.download_url;
            
            document.getElementById('currentFileName').innerText = file.cleanName;
            
            const dlBtn = document.getElementById('downloadBtn');
            const openBtn = document.getElementById('openNewTabBtn');
            dlBtn.href = downloadUrl;
            dlBtn.style.display = 'inline-flex';
            openBtn.href = liveUrl;
            openBtn.style.display = 'inline-flex';

            viewer.innerHTML = '<i class="fas fa-spinner fa-spin fa-3x"></i>';

            setTimeout(() => {
                if (['jpg', 'jpeg', 'png', 'gif', 'svg'].includes(ext)) {
                    viewer.innerHTML = `<img src="${liveUrl}" onerror="this.src='${downloadUrl}'">`;
                }
                else if (['mp4', 'webm', 'mp3'].includes(ext)) {
                    viewer.innerHTML = `<video controls src="${liveUrl}" style="max-height:100%"></video>`;
                }
                else if (['pdf', 'html', 'htm', 'txt'].includes(ext)) {
                    viewer.innerHTML = `<iframe src="${liveUrl}" style="background:white;"></iframe>`;
                }
                else if (['doc', 'docx', 'xls', 'xlsx', 'ppt', 'pptx'].includes(ext)) {
                    viewer.innerHTML = `<iframe src="https://view.officeapps.live.com/op/embed.aspx?src=${encodeURIComponent(liveUrl)}"></iframe>`;
                }
                else {
                    viewer.innerHTML = `<iframe src="https://docs.google.com/gview?url=${encodeURIComponent(liveUrl)}&embedded=true"></iframe>`;
                }
            }, 200);
        }

        function filterFiles() { renderTable(allFiles); }
        function getFileIcon(name) {
            const ext = name.split('.').pop().toLowerCase();
            if (ext === 'pdf') return 'fa-solid fa-file-pdf style="color:#dc3545"';
            if (['doc','docx'].includes(ext)) return 'fa-solid fa-file-word style="color:#007bff"';
            if (['xls','xlsx'].includes(ext)) return 'fa-solid fa-file-excel style="color:#28a745"';
            if (['jpg','png'].includes(ext)) return 'fa-solid fa-file-image style="color:#ffc107"';
            if (['html','htm'].includes(ext)) return 'fa-brands fa-html5 style="color:#e34f26"';
            return 'fa-solid fa-file style="color:#6c757d"';
        }
        function toggleTheme() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            localStorage.setItem('dark-mode', isDark);
            document.getElementById('themeIcon').className = isDark ? 'fa-solid fa-sun' : 'fa-solid fa-moon';
        }
    </script>
</body>
</html>
