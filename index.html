<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>أداة إعداد قائمة المستندات</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
        href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap"
        rel="stylesheet"
    />
    <style>
        body { font-family: "Cairo", sans-serif; background-color: #f0f2f5; color: #333; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .container { background-color: white; padding: 25px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); width: 90%; max-width: 1200px; display: grid; grid-template-columns: 1fr 2fr; grid-template-rows: auto 1fr; gap: 20px; grid-template-areas: "header header" "sidebar main"; }
        header { grid-area: header; text-align: center; border-bottom: 1px solid #eee; padding-bottom: 20px; }
        header h1 { margin: 0; color: #2c3e50; }
        .sidebar { grid-area: sidebar; display: flex; flex-direction: column; gap: 15px; }
        .main-content { grid-area: main; display: flex; flex-direction: column; }
        button { background-color: #3498db; color: white; border: none; padding: 12px 20px; border-radius: 5px; cursor: pointer; font-size: 1.1em; font-family: "Cairo", sans-serif; transition: background-color 0.3s; }
        button:hover { background-color: #2980b9; }
        #export-json-btn { background-color: #2ecc71; }
        #export-json-btn:hover { background-color: #27ae60; }
        #file-list { list-style-type: none; padding: 0; margin: 0; border: 1px solid #ddd; border-radius: 5px; background-color: #f9f9f9; overflow-y: auto; height: 300px; }
        #file-list li { padding: 10px; cursor: pointer; border-bottom: 1px solid #eee; }
        #file-list li:hover { background-color: #e9e9e9; }
        #json-output { width: 100%; height: 200px; font-family: monospace; font-size: 1em; border: 1px solid #ddd; border-radius: 5px; padding: 10px; direction: ltr; resize: vertical; }
        #preview { flex-grow: 1; border: 1px solid #ddd; border-radius: 5px; display: flex; justify-content: center; align-items: center; background-color: #f9f9f9; min-height: 400px; }
        #preview-iframe { width: 100%; height: 100%; border: none; }
        .info { color: #7f8c8d; text-align: center; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>أداة إعداد ملف `file-list.json`</h1>
            <p class="info">تعمل هذه الأداة محلياً على جهازك لمساعدتك في إنشاء قائمة الملفات.</p>
        </header>

        <aside class="sidebar">
            <button id="select-folder-btn">① اختر مجلد المستندات</button>
            <h4>الملفات التي تم العثور عليها:</h4>
            <ul id="file-list"><li class="info">...في انتظار اختيار المجلد</li></ul>
            <h4>② محتوى JSON:</h4>
            <textarea id="json-output" readonly>سيظهر الكود هنا...</textarea>
            
            <button id="export-json-btn" disabled>③ تصدير ملف file-list.json</button>
        </aside>

        <main class="main-content">
            <h4>المعاينة أو الفتح:</h4>
            <div id="preview"><p class="info">انقر على ملف من القائمة لمعاينته (PDF) أو لفتحه في البرنامج المخصص له (Office)</p></div>
        </main>
    </div>

    <script>
        const selectFolderBtn = document.getElementById("select-folder-btn");
        const fileListElement = document.getElementById("file-list");
        const jsonOutput = document.getElementById("json-output");
        const exportJsonBtn = document.getElementById("export-json-btn"); // تم تحديث المتغير
        const previewElement = document.getElementById("preview");
        let fileHandles = new Map();

        selectFolderBtn.addEventListener("click", async () => {
            if (!("showDirectoryPicker" in window)) {
                alert("عذراً، متصفحك لا يدعم هذه الميزة. الرجاء استخدام Google Chrome أو Microsoft Edge.");
                return;
            }
            try {
                const dirHandle = await window.showDirectoryPicker();
                const fileNames = [];
                fileHandles.clear();
                fileListElement.innerHTML = "";
                for await (const entry of dirHandle.values()) {
                    if (entry.kind === "file" && !entry.name.startsWith(".")) {
                        fileNames.push(entry.name);
                        fileHandles.set(entry.name, entry);
                        const li = document.createElement("li");
                        li.textContent = entry.name;
                        li.addEventListener("click", () => displayLocalFile(entry.name));
                        fileListElement.appendChild(li);
                    }
                }
                fileNames.sort();
                jsonOutput.value = JSON.stringify(fileNames, null, 2);
                
                // تفعيل زر التصدير بعد إنشاء القائمة
                exportJsonBtn.disabled = false;

                if (fileNames.length === 0) {
                    fileListElement.innerHTML = '<li class="info">لم يتم العثور على ملفات.</li>';
                    exportJsonBtn.disabled = true; // تعطيل الزر إذا لا توجد ملفات
                }
            } catch (err) {
                if (err.name !== "AbortError") console.error(err);
            }
        });
        
        // --- الدالة الجديدة لتصدير الملف ---
        function exportJsonFile() {
            const jsonData = jsonOutput.value;
            if (!jsonData || jsonData === 'سيظهر الكود هنا...') {
                alert('لا يوجد محتوى لتصديره. الرجاء اختيار مجلد المستندات أولاً.');
                return;
            }

            // إنشاء كائن Blob من النص
            const blob = new Blob([jsonData], { type: 'application/json' });
            
            // إنشاء رابط وهمي لتنزيل الملف
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'file-list.json'; // اسم الملف الذي سيتم تنزيله
            document.body.appendChild(a);
            a.click();
            
            // تنظيف الرابط بعد التنزيل
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // --- ربط الدالة الجديدة بالزر ---
        exportJsonBtn.addEventListener("click", exportJsonFile);

        async function displayLocalFile(fileName) {
            const fileHandle = fileHandles.get(fileName);
            if (!fileHandle) return;
            const file = await fileHandle.getFile();
            const fileExtension = fileName.split(".").pop().toLowerCase();

            if (fileExtension === "pdf") {
                previewElement.innerHTML = "";
                const objectURL = URL.createObjectURL(file);
                const iframe = document.createElement("iframe");
                iframe.id = "preview-iframe";
                iframe.src = objectURL;
                previewElement.appendChild(iframe);
            } else if (["docx", "pptx", "xlsx", "doc", "ppt", "xls"].includes(fileExtension)) {
                const objectURL = URL.createObjectURL(file);
                const tempLink = document.createElement("a");
                tempLink.href = objectURL;
                tempLink.download = fileName;
                document.body.appendChild(tempLink);
                tempLink.click();
                document.body.removeChild(tempLink);
                URL.revokeObjectURL(objectURL);
                previewElement.innerHTML = `<p class="info">👍<br>تم بدء تنزيل ملف '${fileName}'.<br>انقر على الملف في شريط التنزيلات لفتحه.</p>`;
            } else {
                previewElement.innerHTML = `<p class="info">نوع الملف (${fileExtension}) غير مدعوم للمعاينة أو الفتح المباشر.</p>`;
            }
        }
    </script>
</body>
</html>
